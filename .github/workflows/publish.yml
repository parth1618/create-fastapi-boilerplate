name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # Allows manual trigger

permissions:
  contents: write  # Needed for uploading release assets

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for version/tag logic

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      # -------------------------------------------------
      # 1. Extract version from tag (e.g. v1.0.1 â†’ 1.0.1)
      # -------------------------------------------------
      - name: Get version from tag
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"  # Remove 'v' prefix
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # -------------------------------------------------
      # 2. Verify pyproject.toml version matches tag
      # -------------------------------------------------
      - name: Validate version match
        run: |
          PKG_VERSION=$(python -c "
          import tomllib, sys
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
              print(data['project']['version'])
          ")
          TAG="${{ steps.version.outputs.tag }}"
          EXPECTED="v$PKG_VERSION"
          
          if [ "$TAG" != "$EXPECTED" ]; then
            echo "ERROR: Tag '$TAG' does not match pyproject.toml version '$PKG_VERSION'"
            echo "Fix: Use 'git tag v$PKG_VERSION' and push"
            exit 1
          fi
          echo "Version match: $TAG == v$PKG_VERSION"

      # -------------------------------------------------
      # 3. Check if version already exists on PyPI
      # -------------------------------------------------
      - name: Check PyPI for existing version
        id: pypi_check
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Checking PyPI for version $VERSION..."
          if curl -sf "https://pypi.org/pypi/create-fastapi-boilerplate/$VERSION/json" > /dev/null; then
            echo "Version $VERSION already exists on PyPI. Skipping upload."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $VERSION not found. Will build and upload."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------
      # 4. Clean and build ONLY if needed
      # -------------------------------------------------
      - name: Clean old artifacts
        if: steps.pypi_check.outputs.exists != 'true'
        run: |
          echo "Cleaning old build artifacts..."
          rm -rf dist/ build/ *.egg-info

      - name: Build package
        if: steps.pypi_check.outputs.exists != 'true'
        run: |
          echo "Building package..."
          python -m build

      # -------------------------------------------------
      # 5. Upload to PyPI ONLY if new
      # -------------------------------------------------
      - name: Publish to PyPI
        if: steps.pypi_check.outputs.exists != 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          echo "Uploading to PyPI..."
          twine upload dist/*

      # -------------------------------------------------
      # 6. Always upload built assets to GitHub Release
      # -------------------------------------------------
      - name: Upload wheels to GitHub Release
        if: always()  # Run even if upload skipped
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: dist/create_fastapi_boilerplate-${{ steps.version.outputs.version }}-py3-none-any.whl
          asset_name: create_fastapi_boilerplate-${{ steps.version.outputs.version }}-py3-none-any.whl
          asset_content_type: application/x-wheel+zip

      - name: Upload source tarball to GitHub Release
        if: always()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: dist/create_fastapi_boilerplate-${{ steps.version.outputs.version }}.tar.gz
          asset_name: create_fastapi_boilerplate-${{ steps.version.outputs.version }}.tar.gz
          asset_content_type: application/gzip

      # -------------------------------------------------
      # 7. Success message
      # -------------------------------------------------
      - name: Done
        run: |
          if [ "${{ steps.pypi_check.outputs.exists }}" = "true" ]; then
            echo "Version ${{ steps.version.outputs.version }} already on PyPI. Release assets attached."
          else
            echo "Successfully published ${{ steps.version.outputs.version }} to PyPI!"
          fi